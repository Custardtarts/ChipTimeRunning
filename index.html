<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chip Time Robin Hood Half Marathon Sweepstake</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">

        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-slate-900 tracking-tight">Chip Time Robin Hood Half Marathon Sweepstake</h1>
            <p class="mt-3 text-lg text-slate-600">Who can guess the team's total running time?</p>
        </header>

        <main class="space-y-8">

            <section class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
                <h2 class="text-2xl font-bold mb-4 text-slate-900">How It Works</h2>
                <ol class="list-decimal list-inside space-y-3 text-slate-700">
                    <li>Captain has shared his predicted race times below. I've added them all up to get a **Predicted Team Total**.</li>
                    <li>To enter, make a £5 contribution to the prize pot using the PayPal Money Pool link.</li>
                    <li>Submit your guess for what the **Actual Team Total** will be on race day.</li>
                    <li>The person whose guess is the closest to the actual combined time wins the pot and eternal bragging rights!</li>
                </ol>
            </section>

            <section>
                <h2 class="text-2xl font-bold mb-4 text-center text-slate-900">Meet the Runners</h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    <div class="bg-white p-4 rounded-2xl shadow-md text-center border border-slate-200">
                        <div class="text-3xl mb-1">🏃‍♂️</div>
                        <p class="font-bold text-base truncate">Chris O.R.</p>
                        <p class="text-slate-500 text-sm">Predicted: <span class="font-semibold text-slate-600">1:27:15</span></p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-md text-center border border-slate-200">
                        <div class="text-3xl mb-1">🏃‍♂️</div>
                        <p class="font-bold text-base truncate">Seb D.H.</p>
                        <p class="text-slate-500 text-sm">Predicted: <span class="font-semibold text-slate-600">1:27:50</span></p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-md text-center border border-slate-200">
                        <div class="text-3xl mb-1">🏃‍♂️</div>
                        <p class="font-bold text-base truncate">Dave D.R.</p>
                        <p class="text-slate-500 text-sm">Predicted: <span class="font-semibold text-slate-600">1:28:50</span></p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-md text-center border border-slate-200">
                        <div class="text-3xl mb-1">&#128021</div>
                        <p class="font-bold text-base truncate">Joe Dogman</p>
                        <p class="text-slate-500 text-sm">Predicted: <span class="font-semibold text-slate-600">1:29:30</span></p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-md text-center border border-slate-200">
                        <div class="text-3xl mb-1">🏃‍♂️</div>
                        <p class="font-bold text-base truncate">Luke Duracell</p>
                        <p class="text-slate-500 text-sm">Predicted: <span class="font-semibold text-slate-600">1:31:10</span></p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-md text-center border border-slate-200">
                        <div class="text-3xl mb-1">🏃‍♂️</div>
                        <p class="font-bold text-base truncate">Ed T.I.A.B.</p>
                        <p class="text-slate-500 text-sm">Predicted: <span class="font-semibold text-slate-600">1:33:45</span></p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-md text-center border border-slate-200">
                        <div class="text-3xl mb-1"> </div>
                        <p class="font-bold text-base truncate">Scott No Show</p>
                        <p class="text-slate-500 text-sm">Predicted: <span class="font-semibold text-slate-600">1:35:01</span></p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-md text-center border border-slate-200">
                        <div class="text-3xl mb-1">🏃‍♂️</div>
                        <p class="font-bold text-base truncate">Dan Biscuits</p>
                        <p class="text-slate-500 text-sm">Predicted: <span class="font-semibold text-slate-600">1:38:20</span></p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-md text-center border border-slate-200">
                        <div class="text-3xl mb-1">🏃‍♂️</div>
                        <p class="font-bold text-base truncate">Rich L.N.</p>
                        <p class="text-slate-500 text-sm">Predicted: <span class="font-semibold text-slate-600">1:38:21</span></p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-md text-center border border-slate-200">
                        <div class="text-3xl mb-1">🏃‍♂️</div>
                        <p class="font-bold text-base truncate">Matt D.V.</p>
                        <p class="text-slate-500 text-sm">Predicted: <span class="font-semibold text-slate-600">1:40:25</span></p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-md text-center border border-slate-200">
                        <div class="text-3xl mb-1">🏃‍♂️</div>
                        <p class="font-bold text-base truncate">Dave B.S.</p>
                        <p class="text-slate-500 text-sm">Predicted: <span class="font-semibold text-slate-600">1:44:59</span></p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-md text-center border border-slate-200">
                        <div class="text-3xl mb-1">🏃‍♂️</div>
                        <p class="font-bold text-base truncate">Jim Nips</p>
                        <p class="text-slate-500 text-sm">Predicted: <span class="font-semibold text-slate-600">1:45:25</span></p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-md text-center border border-slate-200">
                        <div class="text-3xl mb-1">🏃‍♂️</div>
                        <p class="font-bold text-base truncate">Andy H.</p>
                        <p class="text-slate-500 text-sm">Predicted: <span class="font-semibold text-slate-600">1:45:26</span></p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-md text-center border border-slate-200">
                        <div class="text-3xl mb-1">🏃‍♂️</div>
                        <p class="font-bold text-base truncate">Rex Littlewood</p>
                        <p class="text-slate-500 text-sm">Predicted: <span class="font-semibold text-slate-600">1:47:45</span></p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-md text-center border border-slate-200">
                        <div class="text-3xl mb-1">🏃‍♂️</div>
                        <p class="font-bold text-base truncate">Andy A.</p>
                        <p class="text-slate-500 text-sm">Predicted: <span class="font-semibold text-slate-600">1:48:57</span></p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-md text-center border border-slate-200">
                        <div class="text-3xl mb-1">🏃‍♂️</div>
                        <p class="font-bold text-base truncate">Tom new</p>
                        <p class="text-slate-500 text-sm">Predicted: <span class="font-semibold text-slate-600">1:48:58</span></p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-md text-center border border-slate-200">
                        <div class="text-3xl mb-1">🏃‍♀️</div>
                        <p class="font-bold text-base truncate">Laura Munro</p>
                        <p class="text-slate-500 text-sm">Predicted: <span class="font-semibold text-slate-600">1:49:59</span></p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-md text-center border border-slate-200">
                        <div class="text-3xl mb-1">&#129373</div>
                        <p class="font-bold text-base truncate">Connor Kiwi</p>
                        <p class="text-slate-500 text-sm">Predicted: <span class="font-semibold text-slate-600">1:55:20</span></p>
                    </div>
                </div>
            </section>

            <section class="bg-blue-600 text-white text-center p-6 rounded-2xl shadow-2xl">
                <h3 class="text-lg font-medium opacity-90">Predicted Combined Time</h3>
                <p id="predicted-total" class="text-5xl sm:text-6xl font-black tracking-tight">29:57:16</p>
            </section>
            
            <section class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
                <h2 class="text-2xl font-bold mb-4 text-slate-900">Place Your Guess!</h2>
                <div class="space-y-4">
                    <div>
                        <p class="font-semibold mb-2">Step 1: Contribute to the Prize Pot</p>
                        <a href="https://www.paypal.com/pool/9iAICUM79r" target="_blank" class="w-full flex items-center justify-center gap-3 bg-yellow-400 hover:bg-yellow-500 text-blue-900 font-bold py-3 px-6 rounded-lg transition-transform duration-200 hover:scale-105">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M10.428 15.688c.348.932.604 1.632.768 2.1a.6.6 0 0 1-.528.864H6.336a.6.6 0 0 1-.6-.576c0-.048.012-.108.036-.18.156-.492.528-1.548 1.116-3.18H4.668a.6.6 0 0 1-.6-.648l1.74-10.968a.6.6 0 0 1 .6-.552h4.524c2.544 0 4.14 1.356 3.42 4.08-.432 1.668-1.584 2.604-3.132 2.604h-2.136c-.396 0-.708.204-.84.624ZM15.156 3h4.524a.6.6 0 0 1 .588.6l.96 6.012a.6.6 0 0 1-.588.684h-3.324c-2.544 0-4.14 1.356-3.42 4.08.432 1.668 1.584 2.604 3.132 2.604h.984a.6.6 0 0 1 .588.516l.36 1.836a.6.6 0 0 1-.588.684h-3.9a.6.6 0 0 1-.6-.576c0-.048.012-.108.036-.18.156-.492.528-1.548 1.116-3.18h-2.22c-2.952 0-4.824-2.208-3.792-6.528C9.516 5.604 11.832 3 15.156 3Z"/></svg>
                            <span>Pay into the Money Pool</span>
                        </a>
                        <p class="text-xs text-slate-500 mt-1 text-center">Add £5</p>
                    </div>

                    <form id="guess-form" method="POST">
                        <p class="font-semibold mb-2">Step 2: Submit Your Guess</p>
                        <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
                            <div class="sm:col-span-2">
                                <label for="name" class="sr-only">Your Name</label>
                                <input type="text" name="name" id="name" placeholder="Your Name" required class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="col-span-2 sm:col-span-2 flex items-center gap-2">
                                <label for="hours" class="sr-only">Hours</label>
                                <input type="number" name="hours" id="hours" placeholder="H" min="0" max="99" required class="w-full p-3 border border-slate-300 rounded-lg text-center focus:ring-2 focus:ring-blue-500 focus:border-blue-500" >
                                <span class="font-bold text-slate-400">:</span>
                                <label for="minutes" class="sr-only">Minutes</label>
                                <input type="number" name="minutes" id="minutes" placeholder="M" min="0" max="59" required class="w-full p-3 border border-slate-300 rounded-lg text-center focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <span class="font-bold text-slate-400">:</span>
                                <label for="seconds" class="sr-only">Seconds</label>
                                <input type="number" name="seconds" id="seconds" placeholder="S" min="0" max="59" required class="w-full p-3 border border-slate-300 rounded-lg text-center focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
			<div id="loading-message" class="hidden text-center text-slate-500 my-4">
    				Submitting your guess... Please wait.
			</div>

				<button type="submit" id="submit-button" class="w-full mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-transform duration-200 hover:scale-105">Submit My Guess</button>


                    </form>
                </div>
            </section>
            
            <section>
                <h2 class="text-2xl font-bold mb-4 text-center text-slate-900">Current Guesses</h2>
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-slate-200">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <tbody id="guesses-table">
                                </tbody>
                        </table>
                    </div>
                </div>
            </section>

	    <section class="mt-8">
  		<h2 class="text-2xl font-bold mb-4 text-center text-slate-900">Guess Distribution</h2>
  		<div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
    			<canvas id="guessesChart"></canvas>
  		</div>
	    </section>

        </main>

        <footer class="text-center mt-12 py-4">
            <p class="text-slate-500">Good luck to all the runners!</p>
        </footer>

    </div>

<script>
        document.addEventListener('DOMContentLoaded', function() {
            const guessForm = document.getElementById('guess-form');
            const guessesTable = document.getElementById('guesses-table');
            const webAppUrl = 'https://script.google.com/macros/s/AKfycbwN2AHqwLQ-Twx3p9Jlr81Bw9ZrNXdDRqvzwbR7nuIZ-3luvQGFLNHUQWLiiuvtbmTU/exec'; 

    	    // Helper: convert "HH:MM:SS" to total minutes
            function timeToMinutes(timeStr) {
        	const [h, m, s] = timeStr.split(":").map(Number);
        	return h * 60 + m + (s / 60);
            }

               // Function to fetch and display guesses (table + chart)
    async function fetchGuesses() {
        try {
            const response = await fetch(webAppUrl);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();

            guessesTable.innerHTML = `<tr class="bg-slate-100">
                                        <th class="p-4 font-semibold">Name</th>
                                        <th class="p-4 font-semibold">Guessed Time</th>
                                        <th class="p-4 font-semibold text-right">Difference (Post-Race)</th>
                                    </tr>`;

            const chartData = [];

            for (let i = 1; i < data.length; i++) {
                const rowData = data[i];
                const name = rowData[1];
                const guess = rowData[2];

                // Table row
                const newRow = document.createElement('tr');
                newRow.classList.add('border-t', 'border-slate-200');
                newRow.innerHTML = `
                    <td class="p-4 font-medium">${escapeHTML(name)}</td>
                    <td class="p-4 font-mono">${escapeHTML(guess)}</td>
                    <td class="p-4 font-mono text-right text-slate-500">--:--:--</td>
                `;
                guessesTable.appendChild(newRow);

                // Chart data
                chartData.push({
                    x: timeToMinutes(guess),
                    y: 0,
                    label: name
                });
            }

            renderChart(chartData);
        } catch (error) {
            console.error('Error fetching guesses:', error);
            alert("Failed to load guesses. Please try refreshing the page.");
        }
    }

    // Chart rendering
    let guessesChartInstance;
    function renderChart(chartData) {
        const ctx = document.getElementById('guessesChart').getContext('2d');
        if (guessesChartInstance) guessesChartInstance.destroy();

        guessesChartInstance = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Guesses',
                    data: chartData,
                    pointRadius: 6,
                    backgroundColor: 'rgba(37, 99, 235, 0.7)'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: { display: true, text: 'Guessed Time (Hours)' },
                        ticks: {
                            callback: function(value) {
                                const hours = Math.floor(value / 60);
                                const mins = Math.floor(value % 60);
                                return `${hours}:${String(mins).padStart(2, '0')}`;
                            }
                        }
                    },
                    y: { display: false }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const minutes = context.raw.x;
                                const h = Math.floor(minutes / 60);
                                const m = Math.floor(minutes % 60);
                                const s = Math.round((minutes - Math.floor(minutes)) * 60);
                                return `${context.raw.label}: ${h}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
                            }
                        }
                    }
                }
            }
        });
    }
            
            // Load initial guesses when the page loads
            fetchGuesses();

            guessForm.addEventListener('submit', async function(event) {
                event.preventDefault();

		// Get the loading message and button elements
    		const loadingMessage = document.getElementById('loading-message');
    		const submitButton = document.getElementById('submit-button');

                const nameInput = document.getElementById('name');
                const hoursInput = document.getElementById('hours');
                const minutesInput = document.getElementById('minutes');
                const secondsInput = document.getElementById('seconds');

                const name = nameInput.value.trim();
                const hours = String(hoursInput.value).padStart(2, '0');
                const minutes = String(minutesInput.value).padStart(2, '0');
                const seconds = String(secondsInput.value).padStart(2, '0');

                if (!name) {
                    alert("Please enter your name.");
                    return;
                }

                const formattedTime = `${hours}:${minutes}:${seconds}`;

                const data = {
                    name: name,
                    time: formattedTime
                };

    		// Show the loading message and disable the button
    		loadingMessage.classList.remove('hidden');
    		submitButton.disabled = true;
    		submitButton.classList.remove('bg-green-600', 'hover:bg-green-700');
    		submitButton.classList.add('bg-gray-400');

                try {
                        const response = await fetch(webAppUrl, {
        			method: 'POST',
        			body: JSON.stringify(data),
        			headers: {
            				'Content-Type': 'text/plain;charset=utf-8'
                        }
                    });

                    if (response.ok) {
                        // Refetch all guesses after a successful submission to show the new one
                        fetchGuesses();
                        
                        // Reset the form
                        guessForm.reset();
                        nameInput.focus();
                    } else {
                        alert("Submission failed. Please try again.");
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert("An error occurred. Please check the console.");
                }
            });
            
            function escapeHTML(str) {
                const div = document.createElement('div');
                div.appendChild(document.createTextNode(str));
                return div.innerHTML;
            }
        });
    </script>
</body>
</html>
